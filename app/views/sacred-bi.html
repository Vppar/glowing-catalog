<style>

	.gauge-canvas{
		/*margin-top: 12px;
		margin-left: 30px;
		border-right:1px #ccc solid;*/
	}
	.gauge-canvas .goal rect{
		fill:#333;
	}
	.gauge-canvas .goal text{
		fill:#fff;
	}
	.gauge-canvas .snapshot rect{
		fill:#bf1e62; 
	}
	.gauge-canvas .snapshot text{
		fill:#333;
	}
	.gauge-canvas .tip path{
		fill:#bf1e62; 
	}
	.gauge-canvas .tip rect{
		fill:#bf1e62; 
	}
	.gauge-canvas .tip text{
		fill:#fff; 
	}


	h4{
		text-align: center;
	}

	p{
		line-height: 32px;
		margin-bottom: 0;	
	}

	.summarizer.goal small{
		display: block;
		width: 24px;
		height: 12px;
		margin-top: 8px;
		background-color: #333;
		/*background-color: #fbc6dc;*/
	}
	.summarizer.points small{
		display: block;
		width: 24px;
		height: 12px;
		margin-top: 8px;
		background-color: #bf1e62;
	}

	.axis-x path,
	.axis-x line {
		fill: none;
		stroke: none;
		shape-rendering: crispEdges;
	}

	.axis-y path,
	.axis-y line {
		fill: none;
		stroke: none;
		shape-rendering: crispEdges;
	}
	.axis-y .guide{
		stroke: #666;
	}

	.axis-y text {
		font-size: 10px;
		fill:#999;
	}

	.axis-x text {
		font-size: 12px;
		fill:#999;
	}

	/*.goal rect{
		fill:#333; 
	}*/
	.goal text{
		fill:#fff;
	}
	.snapshot rect{
		fill:#bf1e62; 
	}
	.snapshot text{
		fill:#fff;
	}

	.tip text{
		font-size: 10px;
		fill:#fff;
	}
	text.tiptext {
		font-size: 12px;
		fill:#fff;
	}

	.guide{
		stroke: #666;
	}

</style>

<script type="text/javascript">

	var goalColor = '#333'; // preto
	// var goalColor = '#fbc6dc'; // rosa claro


	var degradeColor1 = '#562e3f';
	var degradeColor2 = '#9c2356';
	// var degradeColor1 = '#e989b2';
	// var degradeColor2 = '#e36198';


	var snapshotColor = '#bf1e62'; //rosa
	var topMargin = 40;
	var leftMargin = 40;

	// var tipsColor = '#bf1e62';
	var tipsColor = '#333';


	var values = [
	{order:1,value:105,goal:200,name:'1ª semana'},
	{order:2,value:100,goal:370,name:'2ª semana'},
	{order:3,value:80,goal:600,name:'3ª semana'},
	{order:4,value:50,goal:56,name:'4ª semana'},
	{order:5,value:70,goal:150,name:'5ª semana',
	days: [
	{day:1,value:10},
	{day:2,value:30},
	{day:3,value:20},
	{day:4,value:10},
	]
},
{order:6,goal:210,name:'6ª semana'},
{order:7,goal:100,name:'7ª semana'},
{order:8,goal:79,name:'8ª semana'},
{order:9,goal:244,name:'9ª semana'}
];

var valuesByOrder = d3.nest().key(function(d){ return 'o'+d.order;}).map(values,d3.map);


// function gauge(values){

// 	var width = 120;
// 	var height = 500;
// 	var barWidth = width-60;

// 	var sum_values = d3.sum(values, function(d) {return d.value; });
// 	var sum_goals = d3.sum(values, function(d) {return d.goal; });

// 	var ref = 0;
// 	if(sum_values < sum_goals){
// 		ref = sum_goals;
// 	}else{
// 		ref = sum_values;
// 	}

// 	var y = d3.scale.linear().domain([ref,0]).range([height-topMargin, 0]);

// 	var canvas = d3.select('body').selectAll('div.gauge').append('svg')
// 	.attr('class','gauge-canvas')
// 	.attr('width', width)
// 	.attr('height', height);

// 	//this needs to be refactored. should be more dinamic....
// 	if(sum_values < sum_goals){
// 		drawGoal();
// 		drawSnapshot();

// 		//drawTip(sum_goals,goalColor,1);
// 		drawTip(sum_values,snapshotColor,(sum_values/sum_goals));

// 	}else{
// 		drawSnapshot();
// 		drawGoal();

// 		drawTip(sum_values,snapshotColor,(sum_values/sum_goals));
// 		//drawTip(sum_goals,goalColor,1);

// 	}


// 	function drawTip(value,color,label){

// 		var w = 40;
// 		var h = 20;
// 		var format = d3.format('%');

// 		var triangleMap = d3.svg.line()
// 		.x(function(d){
// 			return d.x;
// 		})
// 		.y(function(d){
// 			return d.y;
// 		});

// 		var triangle = [
// 		{x:barWidth+w/4,y:height - y(value)-h/4},
// 		{x:barWidth+w/4,y:height - y(value)+h/4},
// 		{x:barWidth+w/4-5,y:height - y(value)}
// 		];

// 		var g = canvas
// 		.append('g')
// 		.attr('class', 'tip');

// 		g.append('path')
// 		.attr("d", triangleMap(triangle))
// 		.attr('stroke',color)
// 		.attr('fill',color);

// 		g.append('rect')
// 		.attr('width', w)
// 		.attr('height', h)
// 		.attr('x', barWidth+w/4)
// 		.attr('y', height - y(value)-h/2)
// 		.attr('fill', color);

// 		g.append('text')
// 		.attr('x', barWidth+w/4+w/2)
// 		.attr('y', height - y(value)+3)
// 		.style("text-anchor", "middle")
// 		.text(format(label));
// 	}

// 	function drawGoal(){
// 		var goal = canvas.selectAll('.goal')
// 		.data([sum_goals])
// 		.enter()
// 		.append('g')
// 		.attr('class', 'goal');

// 		goal.append('rect')
// 		.attr('x', 0 )
// 		.attr('y', height - y(sum_goals))
// 		.attr('width', barWidth)
// 		.attr('height', y(sum_goals))
// 		.attr('fill', goalColor);

// 		goal.append("line")
// 		.attr('class','line')
// 		.attr("x1", 0)
// 		.attr("x2", barWidth)
// 		.attr("y1", height - y(sum_goals))
// 		.attr("y2", height - y(sum_goals))
// 		.attr('stroke','#fff');

// 		goal.append('text')
// 		.attr('x',barWidth/2)
// 		.attr('y',height - y(sum_goals)+20)
// 		.style("text-anchor", "middle")
// 		.text(sum_goals)
// 	}

// 	function drawSnapshot(){

// 		var snapshot = canvas.selectAll('.snapshot')
// 		.data([sum_values])
// 		.enter()
// 		.append('g')
// 		.attr('class', 'snapshot');

// 		snapshot.append('rect')
// 		.attr('x', 0 )
// 		.attr('y', height - y(sum_values))
// 		.attr('width', barWidth)
// 		.attr('height', y(sum_values));

// 		snapshot.append("line")
// 		.attr('class','line')
// 		.attr("x1", 0)
// 		.attr("x2", barWidth)
// 		.attr("y1", height - y(sum_values))
// 		.attr("y2", height - y(sum_values))
// 		.attr('stroke','#fff');

// 		snapshot.append('text')
// 		.attr('x',barWidth/2)
// 		.attr('y',height - y(sum_values)+20)
// 		.style("text-anchor", "middle")
// 		.text(sum_values)
// 	}

// }

function cumulative(values){

	var obj = {};
	obj.values = values.map(function(d){ return d.value;}).filter(Number);
	obj.goals = values.map(function(d){ return d.goal;}).filter(Number);


	var valuesCumulative = makeCumulative(obj.values);
	var goalCumulative = makeCumulative(obj.goals);

	// goalCumulative.push(goalCumulative[goalCumulative.length-1]);
	// goalCumulative = goalCumulative.reverse();
	// goalCumulative.push(goalCumulative[goalCumulative.length-1]);
	// goalCumulative = goalCumulative.reverse();

	// valuesCumulative = valuesCumulative.reverse();
	// valuesCumulative.push(valuesCumulative[valuesCumulative.length-1]);
	// valuesCumulative = valuesCumulative.reverse();


	var maxCtrl = true;

	var max = d3.max(valuesCumulative);
	if(max < d3.max(goalCumulative)){
		max = d3.max(goalCumulative);
		maxCtrl = false;
	}

	var valuesByOrder = d3.nest().key(function(d){ return 'o'+d.order;}).map(values,d3.map);

	var width = 800; 
	var height = 200;

	var leftMargin = 40;
	var bottomMargin = 40;
	var barWidth = 80;

	var chartWidth = width-leftMargin;
	var chartHeight = height-(topMargin+bottomMargin);

	var x = d3.scale.ordinal().domain(values.map(function(d){ return d.order;})).rangeRoundBands([leftMargin,width],0);
	var y = d3.scale.linear().domain([max,0]).range([0,chartHeight]);

	var canvas = d3.select('body').selectAll('div.cumulative').append('svg')
	.attr('width', width)
	.attr('height', height);


	drawXAxis();
	drawYAxis();
	//drawArea(goalColor,goalCumulative);
	//drawArea(snapshotColor,valuesCumulative);

	drawGuide(5);

	drawLine(goalColor,goalCumulative);
	drawLine(snapshotColor,valuesCumulative);

	function drawGuide(order){

		var guide = canvas.append("line")
		.attr('class','guide')
		.attr("x1", x(order)+x.rangeBand()/2)
		.attr("x2", x(order)+x.rangeBand()/2)
		.attr("y1", function(d){ return 0;})
		.attr("y2", function(d){ return chartHeight+topMargin;});

	}

	function drawArea(color,points,metric){
		var lineMap = d3.svg.area()
		.x(function(d,i) {
			//if(i == 0) return leftMargin; 
			//else 
			return ((i+1) * x.rangeBand()); 
		})
		.y0(function(d) { 
			return chartHeight;
		})
		.y1(function(d) { 
			return y(d);
		})

		var area = canvas.append('path')
		.attr("d", lineMap(points))
		.attr('stroke',color)
		.attr('fill',color)
		.attr('stroke-linejoin','round')
		.attr("transform", "translate(0,"+topMargin+")");
	}

	function drawLine(color,points){
		var lineMap = d3.svg.line()
		.x(function(d,i) { 
			//if(i == 0) return leftMargin; 
			return ((i+1) * x.rangeBand()); 
		})
		.y(function(d) { 
			return y(d);
		})

		var line = canvas.append('path')
		.attr("d", lineMap(points))
		.attr('stroke',color)
		.attr('fill','none')
		.attr('stroke-linejoin','round')
		.attr('stroke-width','2px')
		.attr("transform", "translate(0,"+topMargin+")");


	}

	function drawYAxis(){

		var qty = 6;

		var yAxis =
		d3.svg.axis()
		.scale(y)
		.ticks(qty)
		.orient('left');

		var axisY = canvas.append("g")
		.attr('class','axis-y')
		.attr("transform", "translate("+leftMargin+","+topMargin+")")
		.call(yAxis);

		axisY.selectAll("line.y")
		.data(y.ticks(qty))
		.enter().append("line")
		.attr('class','guide')
		.attr("x1", 0)
		.attr("x2", leftMargin + chartWidth)
		.attr("y1", function(d){ return y(d);})
		.attr("y2", function(d){ return y(d);});
	}		

	function drawXAxis(){
		var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(function(d){ return valuesByOrder.get('o'+d)[0].name});

		canvas.append("g")
		.attr('class','axis-x')
		.attr("transform", "translate(0,"+(chartHeight+topMargin)+")")
		.call(xAxis);

	}

	function makeCumulative(entry){
		var values = [];
		var last = 0;
		for(var i = 0;i<entry.length;i++){
			last = last + entry[i];
			values.push(last);
		}
		return values;
	}

}

function termometer(values,goal){

	var h = 20;
	var w = 40;
	var format = d3.format('%');

	var width = 800;
	var height = 50;
	var bands = [1,2,3,4];
	var topMargin = 10;
	var colors = [goalColor,degradeColor1,degradeColor2,snapshotColor];

	var x = d3.scale.ordinal().domain(bands).rangeRoundBands([leftMargin,width],0);
	var x2 = d3.scale.linear().domain([0,2]).range([leftMargin,width]);

	var daysSum = d3.sum(values,function(d){ return d.value});

	var termvalue = daysSum/(values.length * (goal/7));

	var v = Math.abs(1 - termvalue); 

	var canvas = d3.select('body').selectAll('div.termometer').append('svg')
	.attr('class','termometer-canvas')
	.attr('width', width)
	.attr('height', height);

	var g = canvas.append('g')
	.attr("transform", "translate("+leftMargin+",25)");

	var bars = g.selectAll('.bar')
	.data(bands)
	.enter();

	bars.append('rect')
	.attr('x', function(d,i){  return (i) * x.rangeBand() })
	.attr('y', 0)
	.attr('width', x.rangeBand())
	.attr('height', function(d){ return 20; })
	.attr('fill', function(d,i){ return colors[i]; });

	var triangleMap = d3.svg.line()
	.x(function(d){
		return d.x;
	})
	.y(function(d){
		return d.y;
	});

	var triangle = [
	{x:w/2-h/4,y:h},
	{x:w/2+h/4,y:h},
	{x:w/2,y:h+h/4}
	];

	var g = canvas
	.append('g')
	.attr('transform', function(d,i){
		return 'translate('+x2(termvalue)+',0)';
	})
	.attr('class', 'tip');

	g.append('path')
	.attr("d", triangleMap(triangle))
	.attr('stroke',tipsColor)
	.attr('fill',tipsColor);

	g.append('rect')
	.attr('width', w)
	.attr('height', h)
	.attr('x', 0)
	.attr('y', 0)
	.attr('fill', tipsColor);

	canvas.append('line')
	.attr('x1', leftMargin+ (x.rangeBand()*2))
	.attr('x2', leftMargin+ (x.rangeBand()*2))
	.attr('y1', 25)
	.attr('y2', 45)
	.attr('stroke','#fff')
	.attr('fill', '#fff');

	var lbl = '';
	if(termvalue > 1){
		lbl = '+ '+format(v);
	}
	else if(termvalue < 1){
		lbl = '- '+format(v);
	}

	g.append('text')
	.attr('x', w/2)
	.attr('y', h/2 + 3)
	.style("text-anchor", "middle")
	.text(lbl);
}

function histogram(values){

	var obj = {};
	obj.values = values.map(function(d){ return d.value;}).filter(Number);
	obj.goals = values.map(function(d){ return d.goal;}).filter(Number);

	obj.hightValues = values.map(
		function(d){ 
			if( d.goal > d.value) return d.goal;
			else return d.value;
		}
		).filter(Number);


	var qty = values.length;

	var maxValue = d3.max(obj.values);
	var maxGoal = d3.max(obj.goals);

	var max = maxValue;
	if(max < maxGoal){
		max = maxGoal;
	}


	var width = 800; 
	var height = 200;
	var bottomMargin = 40;
	var barWidth = (width/qty)-10;

	var chartWidth = width-leftMargin;
	var chartHeight = height-(topMargin+bottomMargin);



	// var x = d3.scale.linear().domain([0, chartWidth]).range([0, chartWidth]);
	var x = d3.scale.ordinal().domain(values.map(function(d){ return d.order;})).rangeRoundBands([leftMargin,width],0);
	var y = d3.scale.linear().domain([max,0]).range([0,chartHeight]);

	var canvas = d3.select('body').selectAll('div.ddd').append('svg')
	.attr('width', width)
	.attr('height', height);


	drawYAxis();
	drawXAxis();
	drawBars(obj.goals,goalColor);
	drawGuide(5);
	var s = drawBars(obj.values,snapshotColor);
	drawTips(obj.hightValues,tipsColor);


	//drawArea(snapshotColor,obj.values);
	//drawLine(snapshotColor,obj.values);



	function drawGuide(order){

		var guide = canvas.append("line")
		.attr('class','guide')
		.attr("x1", x(order)+x.rangeBand()/2)
		.attr("x2", x(order)+x.rangeBand()/2)
		.attr("y1", function(d){ return 0;})
		.attr("y2", function(d){ return chartHeight+topMargin;});

	}

	function drawArea(color,points){

		points.push(0);
		points = points.reverse();
		points.push(0);
		points = points.reverse()


		var lineMap = d3.svg.area()
		.x(function(d,i) { 
			if(i == 0) return leftMargin;
			else return ((i) * x.rangeBand()); 
		})
		.y0(function(d) { 
			return chartHeight;
		})
		.y1(function(d) {
			return y(d);
		})

		var line = canvas.append('path')
		.attr("d", lineMap(points))
		.attr('stroke',color)
		.attr('fill',color)
		.attr('stroke-linejoin','round')
		.attr('stroke-width','2px')
		.attr("transform", "translate(0,"+topMargin+")");
	}

	function drawBars(values,color){

		var g = canvas.append('g')
		.attr("transform", "translate(0,"+topMargin+")");

		var bars = g.selectAll('.bar')
		.data(values)
		.enter();

		bars.append('rect')
		.attr('x', function(d,i){  return ((i+1) * x.rangeBand())-(barWidth/2);  })
		.attr('y', function(d){ return y(d); })
		.attr('width', barWidth)
		.attr('height', function(d){ return chartHeight-y(d); })
		.attr('fill', color );

		return bars;
	}

	function drawTips(values,color){

		var w = 40;
		var h = 20;

		var format = d3.format('%');

		var triangleMap = d3.svg.line()
		.x(function(d){
			return d.x;
		})
		.y(function(d){
			return d.y;
		});

		var triangle = [
		{x:-h/4,y:-h/4},
		{x:h/4,y:-h/4},
		{x:0,y:0}
		];

		var g = canvas.append('g')
		.attr("transform", "translate(0,"+topMargin+")");

		var tips = g.selectAll('.tips')
		.data(values)
		.enter();

		var gs = tips.append('g')
		.attr('transform', function(d,i){
			var xi = ((i+1) * x.rangeBand());
			var yi = y(d)-30+h+(h/4);
			return 'translate('+xi+','+yi+')';
		})
		.attr('class','tip')
		.append('path')
		.attr("d", triangleMap(triangle))
		.attr('stroke',color)
		.attr('fill',color);

		tips.append('rect')
		.attr('width', w)
		.attr('height', h)
		.attr('x', function(d,i){  return ((i+1) * x.rangeBand())-(barWidth/2)+w/2;  })
		.attr('y', function(d){ return y(d)-30; })
		.attr('fill', color);
		tips.append('text')
		.attr('class','tiptext')
		.attr('x', function(d,i){  return ((i+1) * x.rangeBand())+(x.rangeBand()-barWidth)/2;  })
		.attr('y', function(d){ return y(d)-15; })
		.attr('fill', '#333')
		.style("text-anchor", "middle")
		.text(function(d,i){
			var o = 'o'+(i+1);
			var v = valuesByOrder.get(o)[0];
			var r = Number(v.value/v.goal);
			return format(r);
		});
	}

	function drawLine(color,points){
		var lineMap = d3.svg.line()
		.x(function(d,i) { 
			return ((i+1) * x.rangeBand()); 
		})
		.y(function(d) { 
			return y(d);
		})

		var line = canvas.append('path')
		.attr("d", lineMap(points))
		.attr('stroke',color)
		.attr('fill','none')
		.attr('stroke-linejoin','round')
		.attr('stroke-width','2px')
		.attr("transform", "translate(0,"+topMargin+")");


	}

	function drawYAxis(){

		var qtyTicks = 5;

		var yAxis =
		d3.svg.axis()
		.scale(y)
		.ticks(qtyTicks)
		.orient('left');

		var axisY = canvas.append("g")
		.attr('class','axis-y')
		.attr("transform", "translate("+leftMargin+","+topMargin+")")
		.call(yAxis);

		axisY.selectAll("line.y")
		.data(y.ticks(qtyTicks))
		.enter().append("line")
		.attr('class','guide')
		.attr("x1", 0)
		.attr("x2", leftMargin + chartWidth)
		.attr("y1", function(d){ return y(d);})
		.attr("y2", function(d){ return y(d);});
	}

	function drawXAxis(){
		var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(function(d){ return valuesByOrder.get('o'+d)[0].name});

		canvas.append("g")
		.attr('class','axis-x')
		.attr("transform", "translate(0,"+(chartHeight+topMargin)+")")
		.call(xAxis);	
	}
}


histogram(values);
var current = valuesByOrder.get('o5')[0];
termometer(current.days,current.goal);
cumulative(values);






</script>

<div id="sacred">
	<div class="container">

		<div ng-include src="'views/parts/global/header.html'"></div>

		<div class="page sacred-bi-page">

			<div class="page-header">
				<div class="row">
					<div class="col-10">
						<div class="title">Análise de Desempenho - Equipe</div>
					</div>
					<div class="col-14">
						<div class="btn-group pull-right page-button" ng-init="ol='dashboard'">
							<a class="btn btn-option" ng-class="{active: ol=='demo'}" ng-click="ol='demo'">Demostrativo</a>
							<a class="btn btn-option" ng-class="{active: ol=='dashboard'}" ng-click="ol='orders'">Dashboard</a>	
						</div>
					</div>
				</div>
			</div>

			<div class="page-body">
				<div class="row">
					<div class="col-8">
						<p>Meta Desafio PARIS
							<small>período: 01/04/2014 a 30/05/2014</small></p>
						</div>
						<div class="col-8">
							<div class="summarizer goal">
								<div class="summarizer-label">Meta</div>
								<div class="summarizer-value">1234</div>
								<small></small>
							</div>
						</div>
						<div class="col-8">
							<div class="summarizer points">
								<div class="summarizer-label">Pontos</div>
								<div class="summarizer-value">1234</div>
								<small></small>
							</div>
						</div>
					</div>
					<div class="row" ng-init='values={goal:200,snapshot:100}'>
						<div class="col-4">
							<h4>Gauge</h4>
							<gauge values='values'tip='true' height='400' ></gauge>
						</div>
						<div class="col-20">
							<div class="ddd">
								<h4>Por Semana</h4>

							</div>

							<div class="termometer">
								<h4>Termômetro</h4>
							</div>

							<div class="cumulative">
								<h4>Acumulado</h4>

							</div>
						</div>
					</div>

				</div>
			</div>

		</div>
	</div>
</div>