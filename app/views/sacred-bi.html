<style>

	.axis-x path,
	.axis-x line {
		fill: none;
		stroke: none;
		shape-rendering: crispEdges;
	}

	.axis-y path,
	.axis-y line {
		fill: none;
		stroke: none;
		shape-rendering: crispEdges;
	}
	.axis-y .guide{
		stroke:1px;
		stroke: #666;
	}

	.axis-y text {
		font-size: 10px;
		fill:#666;
	}

	.axis-x text {
		font-size: 12px;
		fill:#333;
	}

</style>

<script type="text/javascript">

	

	var values = [
	{order:1,value:105,goal:200,name:'1ª semana'},
	{order:2,value:100,goal:70,name:'2ª semana'},
	{order:3,value:80,goal:600,name:'3ª semana'},
	{order:4,value:50,goal:56,name:'4ª semana'},
	{order:5,value:120,goal:120,name:'5ª semana'},
	{order:6,value:200,goal:210,name:'6ª semana'},
	{order:7,value:120,goal:100,name:'7ª semana'},
	{order:8,value:70,goal:79,name:'8ª semana'},
	{order:9,value:750,goal:244,name:'9ª semana'}
	];


	function gauge(values){

		var width = 100; 
		var height = 400;
		var topmargin = 40;

		var sum_values = d3.sum(values, function(d) {return d.value; });
		var sum_goals = d3.sum(values, function(d) {return d.goal; });

		var ref = 0;
		if(sum_values < sum_goals){
			ref = sum_goals;
		}else{
			ref = sum_values;
		}

		var y = d3.scale.linear().domain([ref,0]).range([height-topmargin, 0]);

		var canvas = d3.select('body').selectAll('div.gauge').append('svg')
		.attr('width', width)
		.attr('height', height);

		//this needs to be refactored. should be more dinamic....
		if(sum_values < sum_goals){
			drawGoal();
			drawSnapshot();

		}else{
			drawSnapshot();
			drawGoal();
		}

		function drawGoal(){
			var goal = canvas.selectAll('.goal')
			.data([sum_goals])
			.enter()
			.append('g')
			.attr('class', 'goal');

			goal.append('rect')
			.attr('x', 0 )
			.attr('y', height - y(sum_goals))
			.attr('width', width)
			.attr('height', y(sum_goals))
			.attr('fill', '#000');
		}

		function drawSnapshot(){

			var snapshot = canvas.selectAll('.snapshot')
			.data([sum_values])
			.enter()
			.append('g')
			.attr('class', 'snapshot');

			snapshot.append('rect')
			.attr('x', 0 )
			.attr('y', height - y(sum_values))
			.attr('width', width)
			.attr('height', y(sum_values))
			.attr('fill', '#f00');
		}
		
	}

	function cumulative(values){

		var valuesCumulative = makeCumulative(values.map(function(d){ return d.value; }));
		var goalCumulative = makeCumulative(values.map(function(d){ return d.goal; }));

		var maxCtrl = true;

		var max = d3.max(valuesCumulative);
		if(max < d3.max(goalCumulative)){
			max = d3.max(goalCumulative);
			maxCtrl = false;
		}

		var valuesByOrder = d3.nest().key(function(d){ return 'o'+d.order;}).map(values,d3.map);
		
		var width = 800; 
		var height = 200;
		var topMargin = 40;
		var leftMargin = 40;
		var bottomMargin = 40;
		var barWidth = 50;

		var chartWidth = width-leftMargin;
		var chartHeight = height-(topMargin+bottomMargin);

		var x = d3.scale.ordinal().domain(values.map(function(d){ return d.order;})).rangeRoundBands([leftMargin,width],0);
		var y = d3.scale.linear().domain([max,0]).range([0,chartHeight]);

		var canvas = d3.select('body').selectAll('div.ddd').append('svg')
		.attr('width', width)
		.attr('height', height);


		drawYAxis();
		drawXAxis();
		drawLine('#000',goalCumulative);
		drawLine('#0f0',valuesCumulative);

		function drawLine(color,points,metric){
			var lineMap = d3.svg.line()
			.x(function(d,i) { 
				return ((i+1) * x.rangeBand()); 
			})
			.y(function(d) { 
				return y(d);
			})

			var line = canvas.append('path')
			.attr("d", lineMap(points))
			.attr('stroke',color)
			.attr('fill','none')
			.attr('stroke-linejoin','round')
			.attr('stroke-width','2px')
			.attr("transform", "translate(0,"+topMargin+")");

			var dots = canvas.selectAll('dots')
			.data(points)
			.enter()
			.append('g')
			.attr('class', 'dots');

			dots.append('circle')
			.attr('cx', function(d,i){  return ((i+1) * x.rangeBand());  })
			.attr('cy', function(d){ return y(d); })
			.attr('r', 4)
			.attr("transform", "translate(0,"+topMargin+")")
			.attr('fill', '#000');
		}

		function drawYAxis(){
			var yAxis =
			d3.svg.axis()
			.scale(y)
			.ticks(10)
			.orient('left');

			var axisY = canvas.append("g")
			.attr('class','axis-y')
			.attr("transform", "translate("+leftMargin+","+topMargin+")")
			.call(yAxis);

			axisY.selectAll("line.y")
			.data(y.ticks(10))
			.enter().append("line")
			.attr('class','guide')
			.attr("x1", 0)
			.attr("x2", leftMargin + chartWidth)
			.attr("y1", function(d){ return y(d);})
			.attr("y2", function(d){ return y(d);});
		}		

		function drawXAxis(){
			var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(function(d){ return valuesByOrder.get('o'+d)[0].name});

			canvas.append("g")
			.attr('class','axis-x')
			.attr("transform", "translate(0,"+(chartHeight+topMargin)+")")
			.call(xAxis);
			
		}





		function makeCumulative(entry){
			var values = [];
			var last = 0;
			for(var i = 0;i<entry.length;i++){
				last = last + entry[i];
				values.push(last);
			}
			return values;
		}

	}



	function histogram(values){

		var valuesByOrder = d3.nest().key(function(d){ return 'o'+d.order;}).map(values,d3.map);

		var width = 800; 
		var height = 200;
		var topMargin = 40;
		var leftMargin = 40;
		var bottomMargin = 40;
		var barWidth = 50;

		var chartWidth = width-leftMargin;
		var chartHeight = height-(topMargin+bottomMargin);

		// var x = d3.scale.linear().domain([0, chartWidth]).range([0, chartWidth]);
		var x = d3.scale.ordinal().domain(values.map(function(d){ return d.order;})).rangeRoundBands([leftMargin,width],0);
		var y = d3.scale.linear().domain([d3.max(values, function(d) { return d.value; }),0]).range([0,chartHeight]);

		var canvas = d3.select('body').selectAll('div.ddd').append('svg')
		.attr('width', width)
		.attr('height', height);

		
		drawYAxis();
		drawXAxis();
		drawBars();
		drawLine('#000');

		function drawBars(){
			var bars = canvas.selectAll('.bar')
			.data(values)
			.enter()
			.append('g')
			.attr("transform", "translate(0,"+topMargin+")")
			.attr('class', 'bar');

			bars.append('rect')
			.attr('x', function(d,i){  return ((i+1) * x.rangeBand())-(barWidth/2);  })
			.attr('y', function(d){ return y(d.goal); })
			.attr('width', barWidth)
			.attr('height', function(d){ return chartHeight-y(d.goal); })
			.attr('fill', 'steelblue');
		}

		function drawLine(color){
			var lineMap = d3.svg.line()
			.x(function(d,i) { 
				return i*(chartWidth/values.length)+((chartWidth/values.length)/2); 
			})
			.y(function(d) { 
				return y(d.value);
			})

			var line = canvas.append('path')
			.attr("d", lineMap(values))
			.attr('stroke',color)
			.attr('fill','none')
			.attr('stroke-linejoin','round')
			.attr('stroke-width','2px')
			.attr('transform', 'translate('+leftMargin+','+topMargin+')');

			var dots = canvas.selectAll('dots')
			.data(values)
			.enter()
			.append('g')
			.attr("transform", "translate(0,"+topMargin+")")
			.attr('class', 'dots');

			dots.append('circle')
			.attr('cx', function(d,i){  return ((i+1) * x.rangeBand());  })
			.attr('cy', function(d){ return y(d.value); })
			.attr('r', 4)
			.attr('fill', '#000');
		}

		function drawYAxis(){
			var yAxis =
			d3.svg.axis()
			.scale(y)
			.ticks(10)
			.orient('left');

			var axisY = canvas.append("g")
			.attr('class','axis-y')
			.attr("transform", "translate("+leftMargin+","+topMargin+")")
			.call(yAxis);

			axisY.selectAll("line.y")
			.data(y.ticks(10))
			.enter().append("line")
			.attr('class','guide')
			.attr("x1", 0)
			.attr("x2", leftMargin + chartWidth)
			.attr("y1", function(d){ return y(d);})
			.attr("y2", function(d){ return y(d);});
		}		

		function drawXAxis(){
			var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(function(d){ return valuesByOrder.get('o'+d)[0].name});

			canvas.append("g")
			.attr('class','axis-x')
			.attr("transform", "translate(0,"+(chartHeight+topMargin)+")")
			.call(xAxis);
			
		}




	}


	gauge(values);
	histogram(values);
	cumulative(values);



</script>

<div id="sacred">
	<div class="container">

		<div ng-include src="'views/parts/global/header.html'"></div>

		<div class="page sacred-bi-page">

			<div class="page-header">
				<div class="row">
					<div class="col-10">
						<div class="title">Análise de Desempenho - Equipe</div>
					</div>
					<div class="col-14">
						<div class="btn-group pull-right page-button" ng-init="ol='dashboard'">
							<a class="btn btn-option" ng-class="{active: ol=='demo'}" ng-click="ol='demo'">Demostrativo</a>
							<a class="btn btn-option" ng-class="{active: ol=='dashboard'}" ng-click="ol='orders'">Dashboard</a>	
						</div>
					</div>
				</div>
			</div>

			<div class="page-body">
				<div class="col-24">
					<div class="col-4">
						<div class="gauge">

						</div>
					</div>
					<div class="col-20">
						
						<div class="ddd">

						</div>
					</div>
				</div>
				<div class="col-24">
					<div class="cumulative">

					</div>
				</div>
			</div>
		</div>

	</div>
</div>
</div>